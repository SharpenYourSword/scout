<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />

  <title></title>  
  
  <link href='http://fonts.googleapis.com/css?family=Ubuntu' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Droid+Serif' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="/css/html5-reset.css" />
  <link rel="stylesheet" href="/css/main.css" />
  
  <!--[if lt IE 9]><script src="/js/html5.js"></script><![endif]-->
  
  <script src="/js/jquery-1.7.1.min.js"></script>
  <script src="/js/jquery.pjax.js"></script>
  <script src="/js/jquery.placehold-0.3.min.js"></script>
  <script src="/js/h5f.min.js"></script>
  <script src="/js/main.js"></script>

  <script type="text/javascript">
    // client-side map of a user's keywords and subscriptions, 
    // complete with delicious database IDs (will swap this with a slug or something later)
    var user_subscriptions = {};
    var keyword;
    <% keywords.each do |keyword, subscriptions| %>
      keyword = encodeURIComponent("<%= js_escape keyword.keyword %>");
      user_subscriptions[keyword] = {
        keyword_id: "<%= keyword._id.to_s %>",
        subscriptions: {}
      };
      <% subscriptions.each do |subscription| %>
        user_subscriptions[keyword].subscriptions.<%= subscription.subscription_type %> = '<%= subscription._id.to_s %>';
      <% end %>
    <% end %>
  </script>
</head>

<body>

  <section class="main">

    <section class="entry">
      <% if defined?(keyword) and keyword.errors.any? %>
        <div class="errors">
          <% keyword.errors.full_messages.each do |msg| %>
            <span><%= msg %></span>
          <% end %>
        </div>
      <% end %>
      
      <form class="search" action="/search" method="get" onsubmit="return false">
        <input type="text" class="query" name="keyword" placeholder="keyword or phrase" />
        
        <!-- filled in with ID of saved search if one is loaded -->
        <!-- <input type="hidden" id="keyword_id" name="keyword_id" /> -->
        
        <!-- filled in with keyword that populates the current search results -->
        <!-- <input type="hidden" id="keyword_searched" name="keyword_searched" /> -->
        
        <div class="buttons">
          <button class="image search">Search</button>
        </div>
      </form>
    </section>
    
    <section id="content">
      <%= yield %>
    </section>

  </section>

  <section class="sidebar">
    <div class="login">
      <% if logged_in? %>
        <span>
          <%= current_user.email %>
        </span>
        <br/>
        <a class="logout" href="/logout">logout</a>
      <% else %>
        <span class="logged_out">
          You are not logged in.
          <br/><br/>
          Search away, but you'll have to provide an email to save alerts.
        </span>
        <form action="/users/new" method="post" id="signup_form">
          <input class="redirect" name="redirect" type="hidden" />
          <input class="email" type="email" placeholder="your email" name="email" />

          <button class="text login">Go</button>
        </form>
      <% end %>
    </div>
    
    <ul class="subscriptions">
      <% keywords.each do |keyword, subscriptions| %>
        <%= partial :"partials/keyword", :locals => {:keyword => keyword, :subscriptions => subscriptions} %>
      <% end %>
    </ul>

    <script type="text/javascript">
      // if we're coming in from a permalink, set up anything that would have otherwise been set up along the way
      <% if params[:keyword] %>
        var initial_keyword = encodeURIComponent("<%= js_escape params[:keyword] %>");
        var keyword_id = user_subscriptions[initial_keyword] ? user_subscriptions[initial_keyword].keyword_id : null;

        $("input.query").val(initial_keyword);
      <% end %>
    </script>

  </section>
  
</body>

</html>