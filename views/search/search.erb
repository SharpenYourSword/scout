<% content_for :title do %>
    <div class="follow searchParameters">
        <h2>'<%= h query %>'</h2>
        in 
        <% subscriptions.each_with_index do |subscription, i| %>
          <a class="dataset" href="#<%= subscription.subscription_type %>"><%= subscription.search_name %></a><%= ", " unless i == (subscriptions.size - 1) %>
        <% end %>
    </div>

    <button class="follow search">
        <span>Subscribe</span>
    </button>

    <button class="following search">
      <span>Subscribed</span>
    </button>
<% end %>


<% content_for :sidebar_left do %>
  
  <form class="filters">
  
    <%= hidden_field_tag :query, :class => "query" %>
    <%= hidden_field_tag :subscription_type, :class => "subscription_type" %>

    <!-- subscription-specific filter partial -->

  </form>

  <%= recent_searches %>
<% end %>

<div class="results contentArea right">
    
    <% subscriptions.each do |subscription| %>
        <div class="search"
          id="<%= subscription.subscription_type %>"
          data-subscription="<%= subscription.subscription_type %>"
          >

          <section class="container clear">
            <h3><%= subscription.search_name %></h3>

            <div class="loading">
              <span>Searching ...</span>
            </div>

            <div class="error">
              <span>There was an error while searching.</span>
            </div>

            <div class="populate">
            </div>
          </section>

        </div>
    <% end %>

</div>

<div class="clear"></div>

<script type="text/javascript">
  
  $(function() {
    initializeFilters();
    initializeButton();
    search({per_page: 20, page: 1});
  });

  // initializes both the sidebar form filters, and the top search form
  function initializeFilters() {
    $("input.query").val("<%= h query %>");
    $("input.subscription_type, select.subscription_type").val("<%= subscription.subscription_type %>");
  }

  function initializeButton() {
    <% if subscription.new_record? %>
      $("button.follow").show();
    <% else %>
      $("button.following").show();
    <% end %>

    <% if logged_in? %>
      $("button.follow").click(follow);
      $("button.following").click(unfollow);
    <% else %>
      $("button.search").click(function() {window.location = "/login";});
    <% end %>
  }

  function currentFilters() {
    var filters = {};
    // import subscription data into form
    return {};
  }

  function currentQuery() {
    return $("form.filters input.query").val();
  }

  function currentSubscriptionType() {
    return $("form.filters input.subscription_type").val();
  }

  function follow() {
    var subscription_type = currentSubscriptionType();
    var query = encodeURIComponent(currentQuery());
    var filters = currentFilters();

    var subscription = $.extend(filters, {
      subscription_type: subscription_type,
      query: query
    });

    $("button.follow").hide();
    $("button.following").show();

    $.post("/subscriptions", subscription, function(data) {
      Utils.log("Created new subscription.");
    }).error(function() {
      Utils.log("ERROR creating new subscription.");
      $("button.follow").show();
      $("button.following").hide();
    });

    return false;
  }

  function unfollow() {
    var subscription_type = currentSubscriptionType();
    var query = encodeURIComponent(currentQuery());
    var filters = currentFilters();

    var subscription = $.extend(filters, {
      subscription_type: subscription_type,
      query: query
    });

    $("button.follow").show();
    $("button.following").hide();

    $.post("/subscriptions", $.extend(subscription, {_method: "delete"}), function(data) {
      Utils.log("Remoed subscription.");
    }).error(function() {
      Utils.log("ERROR removing subscription.");
      $("button.follow").hide();
      $("button.following").show();
    });

    return false;
  }

  function search(searchOptions) {
    if (!searchOptions) searchOptions = {};

    var subscription_type = currentSubscriptionType();
    var query = encodeURIComponent(currentQuery());
    var container = $(".results div.search[data-subscription=" + subscription_type + "]");

    // reset elements inside tab
    container.find(".loading").show();
    container.find(".populate").html("").hide();
    
    // all search options (filters, pagination)
    var search = {};
    
    // carry along the universal and subscription-specific filters
    $.extend(search, currentFilters());

    // any one-time search options (pagination)
    $.extend(search, searchOptions);

    $.get("/fetch/search/" + subscription_type + "/" + query, search, function(data) {
      
      container.find(".loading").hide();
      container.find(".populate").html(data.html).show();

      if (data.search_url) {
        $("div.developer.json.search").show().find("a").attr("href", data.search_url);
      }

    }).error(function() {
      container.find(".loading").hide();
      container.find(".error").show();
    });
  }
</script>