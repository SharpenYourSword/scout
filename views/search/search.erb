<% content_for :title do %>
    <div class="trackSubscribe searchParameters">
        <h2>'<%= h query %>'</h2>
        in 
        <% subscriptions.each_with_index do |subscription, i| %>
          <a class="dataset" href="#<%= subscription.subscription_type %>"><%= subscription.search_name %></a><%= ", " unless i == (subscriptions.size - 1) %>
        <% end %>
    </div>
    <button>
        <span>Subscribe</span>
    </button>
<% end %>

<% if false %>
<% content_for :sidebar_left do %>
    <div class="module filters">
        <h4>Filter search results</h4>
        <form>
            <fieldset>
                <legend>Congress</legend>
                <label><input type="checkbox" name="" value="" id="">Bills</label>
                <label><input type="checkbox" name="" value="" id="">Speeches</label>
            </fieldset>
            <fieldset>
                <legend>Regulations</legend>
                <label><input type="checkbox" name="" value="" id="">Proposed/final regulations</label>
            </fieldset>
            <fieldset>                          
                <legend>State Bills</legend>
                <input type="checkbox" name="" value="" id="">
                <select name="category">
                    <option value="" selected="selected">--- All States ---</option>
                    <% state_map.keys.sort.each do |code| %>
                        <option value="<%= code %>"><%= state_map[code] %></option>
                    <% end %>
                </select>
            </fieldset>
            <button type="submit">
                <span>Update results</span>
            </button>
        </form>
    </div>
    <%= recent_searches %>
<% end %>
<% end %>

<div class="contentArea right results">
    
    <% subscriptions.each do |subscription| %>
        <div class="search"
          id="<%= subscription.subscription_type %>"
          data-subscription="<%= subscription.serialize %>"
          >

          <section class="container clear">
            <h3><%= subscription.search_name %></h3>

            <div class="loading">
              <span>Searching ...</span>
            </div>

            <div class="populate">
            </div>
          </section>

        </div>
    <% end %>

</div>

<div class="clear"></div>

<!-- 
<div class="flag overlay">
    <div class="clear"></div>
    <div class="light white">
        <div class="clear"></div>
        <p>You've modified the search parameters on this subscription. Would you like to update it?</p>
        <a class="button update textIndent" type="submit">
            Update
        </a>
        <a class="ignore" type="submit">
            No thanks
        </a>
    </div>
    <div class="fade black"></div>  
</div>

 -->

<script type="text/javascript">
  // put in a delay block in case this is being rendered before the layout
  $(function() {
    var query = "<%= query %>";
    // var query_encoded = encodeURIComponent(query);
    
    // var interest_id = user_subscriptions[query_encoded] ? user_subscriptions[query_encoded].interest_id : null;

    var sole = <%= subscriptions.size == 1 ? "true" : "false" %>;
    <% subscriptions.each do |subscription| %>
      var per_page = sole ? 20 : 2;
      searchFor(query, "<%= subscription.serialize %>", {sole: sole, per_page: per_page});
    <% end %>

    // $(".subscription_data").change(function() {
    //     var subscription_type = $(this).parents("div.filter").data("subscription_type");
    //     searchFor(interest, subscription_type);
    // });
  });

  function searchFor(query, subscription, options) {
      var query_slug = encodeURIComponent(query);
      var container = $(".results div.search[data-subscription=" + subscription + "]");

      // reset elements inside tab
      container.find(".loading").show();
      container.find(".populate").html("").hide();
      
      // assemble hash of any filter options
      var data = {}; // subscriptionData(subscription_type);
      $.extend(data, options);

      $.get("/fetch/search/" + subscription + "/" + query_slug, data, function(data) {
        
        container.find(".loading").hide();
        container.find(".populate").html(data.html).show();

        // if (data.search_url) {
        //   container.find("div.developer.json.search").show().find("a").attr("href", data.search_url);
        // }

        // error
        if (data.count < 0)  {
          // tab.addClass("error");
        } else {
          // container.find("header").show();
          // container.find("div.logged_out").show();
          // container.find("div.filter").show();
          // container.find("header span.description").html(data.description);

          // var button = $("div.tab." + subscription_type + " button.follow");

          // var subscriptions = user_subscriptions[keyword_slug]; // global!
          // if (subscriptions && subscriptions.subscriptions[subscription_type]) {
          //   button.data("subscription_id", subscriptions.subscriptions[subscription_type]);
          //   showSave(subscription_type, "unfollow");
          // } else {
          //   button.data("subscription_id", null);
          //   showSave(subscription_type, "follow");
          // }

          // if (data.count == 0)
          //   tab.addClass("empty");
          
        }

      }).error(function() {
        // tab.removeClass("loading");
        // container.find("div.loading_container").hide();
        // container.find("div.system_error").show();
      });
    }
</script>